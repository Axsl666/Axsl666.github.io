<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-NetworkProtocolSecurity/ipsec">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">IPsec协议 | Jellyfish Page</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.axsl.site/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.axsl.site/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.axsl.site/en/docs/NetworkProtocolSecurity/ipsec"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="IPsec协议 | Jellyfish Page"><meta data-rh="true" name="description" content="前言"><meta data-rh="true" property="og:description" content="前言"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.axsl.site/en/docs/NetworkProtocolSecurity/ipsec"><link data-rh="true" rel="alternate" href="https://www.axsl.site/en/docs/NetworkProtocolSecurity/ipsec" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.axsl.site/docs/NetworkProtocolSecurity/ipsec" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://www.axsl.site/docs/NetworkProtocolSecurity/ipsec" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="Jellyfish Page RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="Jellyfish Page Atom Feed">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/en/assets/css/styles.66d1563d.css">
<link rel="preload" href="/en/assets/js/runtime~main.c25a2a1f.js" as="script">
<link rel="preload" href="/en/assets/js/main.2ee74d0e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Axsl</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/docs/intro">Notes</a><a class="navbar__item navbar__link" href="/en/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Axsl666/Axsl666.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item green"><a class="menu__link" href="/en/docs/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/tutorial---basics">Tutorial - Basics</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorial - Basics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/tutorial---extras">Tutorial - Extras</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorial - Extras&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/cryptography">Cryptography</a><button aria-label="Toggle the collapsible sidebar category &#x27;Cryptography&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/en/docs/category/网络与协议安全基础">网络与协议安全基础</a><button aria-label="Toggle the collapsible sidebar category &#x27;网络与协议安全基础&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/NetworkProtocolSecurity/intro">intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/NetworkProtocolSecurity/Kerberos">Kerberos协议</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/NetworkProtocolSecurity/ipsec">IPsec协议</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/NetworkProtocolSecurity/SET">SET 协议</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/NetworkProtocolSecurity/PGP">PGP协议</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/NetworkProtocolSecurity/ban">BAN逻辑</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/NetworkProtocolSecurity/attack">基于攻击结构性方法</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/2023秋冬季开源操作系统训练营">2023秋冬季开源操作系统训练营</a><button aria-label="Toggle the collapsible sidebar category &#x27;2023秋冬季开源操作系统训练营&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/category/网络与协议安全基础"><span itemprop="name">网络与协议安全基础</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">IPsec协议</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>IPsec协议</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="Direct link to 前言" title="Direct link to 前言">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ip安全问题">IP安全问题<a href="#ip安全问题" class="hash-link" aria-label="Direct link to IP安全问题" title="Direct link to IP安全问题">​</a></h3><ul><li>源地址欺骗</li><li>包重放</li><li>无身份认证</li><li>无数据完整性和机密性</li><li></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概述">概述<a href="#概述" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h2><p>IPSec（互联网协议安全）是一个安全网络协议套件，用于保护互联网或公共网络传输的数据。IETF在 1990 年代中期开发了 IPSec 协议，它通过 IP网络数据包的身份验证和加密来提供 IP 层的安全性。</p><ul><li>IPsec对IPv4是可选的，对IPv6是必须的。</li><li></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ipsec体系">IPsec体系<a href="#ipsec体系" class="hash-link" aria-label="Direct link to IPsec体系" title="Direct link to IPsec体系">​</a></h2><p><img loading="lazy" alt="image-20230413115016876" src="/en/assets/images/image-20230413115016876-d1e37e26fcd8383697385e2295bb6844.png" width="589" height="675" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x01-ipsec概念">0x01 IPsec概念<a href="#0x01-ipsec概念" class="hash-link" aria-label="Direct link to 0x01 IPsec概念" title="Direct link to 0x01 IPsec概念">​</a></h2><ul><li><p>IPSec（互联网协议安全）是一个安全网络协议套件，用于保护互联网或公共网络传输的数据。IETF在 1990 年代中期开发了 IPSec 协议，它通过 IP网络数据包的身份验证和加密来提供 IP 层的安全性。</p></li><li><p>目的：是把安全机制引入IP协议，使用现代密码学方法支持机密性和认证性服务，确保公网上数据通信的可靠性和完整性。 </p></li><li><p>随着IPv6的制定而产生的，IPSec对IPV4是可选的，对IPV6是必须的，IPSec由三种机制共同保障：<strong>认证、信息机密性、密钥管理</strong>。确保通信的可靠性、完整性。</p></li></ul><p>数据源认证 (IP address) 完整性保护 重放攻击保护 机密性和隐私 SJTU School of Cyber Science and EngineeringDOS预防 (Clogging, DOS) Support for IPv4, IPv6 (mandatory in IPv6)</p><p><img loading="lazy" alt="img" src="/en/assets/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1hZMDkxOFpXUQ==,size_16,color_FFFFFF,t_70-ae6e957532f0276b66d41cfd5dd5b49e.png" width="1421" height="889" class="img_ev3q"></p><p><img loading="lazy" alt="IPsec加密验证过程" src="/en/assets/images/download-be181213942135e73d09dfa181a8db44.png" width="495" height="470" class="img_ev3q"></p><p><img loading="lazy" alt="img" src="/en/assets/images/u=3959406897,1038440786&amp;fm=253&amp;app=138&amp;f=PNG&amp;fmt=auto&amp;q=75-48a8ff9d97c3653357d4956b579bb576.png" width="546" height="185" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12--sa-security-associations-安全联盟">1.2  SA (Security Associations) 安全联盟<a href="#12--sa-security-associations-安全联盟" class="hash-link" aria-label="Direct link to 1.2  SA (Security Associations) 安全联盟" title="Direct link to 1.2  SA (Security Associations) 安全联盟">​</a></h3><p>安全联盟（SA）是 IPsec 的一个基本概念，它构成了 IPsec 的基础。见 RFC 1825。
SA 是两个 IPSec 实体之间，经过协商建立起来的一种协定（内容包括各种 IPSec 用到的参数算发等）</p><ul><li>SAs 由<strong>安全参数索引 Security Parameter Index（SPI）</strong>和 <strong>目标地址</strong> 组成</li><li>SA 是单向的，每个通信双方都要有两种 SA，<strong>三元组唯一标识</strong>（SPI，目的 IP 地址，IPSec 协议）<ul><li>SA 的参数 认证算法和模式<ul><li>加密算法和模式</li><li>相关密钥</li><li>密钥生命周期</li><li>SA 生命周期</li><li>SA 源地址</li><li>敏感水平（秘密还是未分类）</li></ul></li><li>SPI 用于标识具有相同 IP 地址和相同安全协议的不同的 SA<ul><li></li></ul></li><li>目的 IP 地址<ul><li>SA 的终端地址</li></ul></li><li>IPsec协议参数<ul><li>AH</li><li>ESP</li><li>AH-ESP</li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-sadsecurity-association-data安全关联数据库">1.3 SAD（Security Association Data）安全关联数据库<a href="#13-sadsecurity-association-data安全关联数据库" class="hash-link" aria-label="Direct link to 1.3 SAD（Security Association Data）安全关联数据库" title="Direct link to 1.3 SAD（Security Association Data）安全关联数据库">​</a></h3><p>SAD包含了所有活跃的 SA 的所有参数信息，存储 SA 的数据库。</p><ul><li><p><strong>对于外出的流量</strong>，如果需要使用 IPSec 处理，然而相应的 SA 不存在，则 IPSec 将启动IKE来协商出一个 SA，并存储到 SAD 中。</p></li><li><p><strong>对于进入的流量</strong>，如果需要进行 IPSec 处理，IPSec 将从 IP 包中得到三元组（SPI,DST,Protocol），并利用这个三元组在 SAD 中查找一个 SA</p></li><li><p>由手工创建 或 经由IKE创建</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="14-spdsecurity-policy-data安全策略库">1.4 SPD（Security Policy Data）安全策略库<a href="#14-spdsecurity-policy-data安全策略库" class="hash-link" aria-label="Direct link to 1.4 SPD（Security Policy Data）安全策略库" title="Direct link to 1.4 SPD（Security Policy Data）安全策略库">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="sp">SP<a href="#sp" class="hash-link" aria-label="Direct link to SP" title="Direct link to SP">​</a></h4><p>Security Policy，安全策略，决定对 IP 数据包是否提供保护，提供何种保护，以何种方式保护（指向 SA）
主要根据源IP地址、目的IP地址、入数据还是出数据等来标识</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="spd">SPD<a href="#spd" class="hash-link" aria-label="Direct link to SPD" title="Direct link to SPD">​</a></h4><p>Security Policy Data，安全策略数据库，将所有的 SP 以某种数据结构集中存储的列表。SPD用于为IPsec 实现提供安全策略配置。</p><ul><li>含有用户定义的策略.：每个报文的安全服务及其水平。</li><li>含有规则列表: &lt;TrafficSelector, action&gt;</li><li>TrafficSelector<ul><li>IP addresses and/or ports (specific or range),</li><li>protocol (TCP/UDP/?);</li></ul></li><li>Action：当接收或将要发出IP包时，首先要查找SPD来决定如何进行处理<ul><li><strong>Discard，丢弃</strong>：流量不能离开主机或者发送到应用程序，也不能进行转发</li><li><strong>Bypass IPsec，不用 IPSec</strong>：对流量作为普通流量处理，不需要额外的 IPSec 保护</li><li><strong>Apply IPsec，使用 IPSec</strong>：对流量应用 IPSec 保护，此时这条安全策略要指向一个 SA。对于<strong>外出流量</strong>，如果该 SA 尚不存在，则启动 IKE 进行协商，把协商的结果连接到该安全策略上；</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="16-ahauthentication-header认证头">1.6 AH（Authentication Header）认证头<a href="#16-ahauthentication-header认证头" class="hash-link" aria-label="Direct link to 1.6 AH（Authentication Header）认证头" title="Direct link to 1.6 AH（Authentication Header）认证头">​</a></h3><p>AH 协议：Authentication Header，认证头协议，协议号：51。见RFC 1826。
工作原理是在每一个数据包上添加一个身份验证报头。此报头包含一个带密钥的hash散列，此hash散列在整个数据包中计算，因此对数据的任何更改将致使散列无效--这样就提供了完整性保护，这样可以确认数据有否被篡改及防止第三方攻击；</p><ul><li>完整性：有，包括IP header （哈希校验） </li><li>认证：有 （共享秘钥）</li><li>防重放：有 （ESP 头中序列号字段）</li><li><strong>数据加密：无，数据无机密性保护</strong></li></ul><p>AH协议为IP通信提供数据源认证、数据完整性和反重播保证，它能保护通信免受篡改，但不能防止窃听，适合用于传输非机密数据。</p><p>AH的工作原理是在每一个数据包上添加一个身份验证报头。</p><p><img loading="lazy" alt="image-20230415160324673" src="/en/assets/images/image-20230415160324673-0af6d8f1b4e09fef76ed349f370a2f0a.png" width="1193" height="675" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="161-ah传输模式点到点">1.6.1 AH传输模式（点到点）<a href="#161-ah传输模式点到点" class="hash-link" aria-label="Direct link to 1.6.1 AH传输模式（点到点）" title="Direct link to 1.6.1 AH传输模式（点到点）">​</a></h4><ul><li>AH被插在IP头之后但在所有的传输层协议(如TCP、UDP)之前，或其它IPSec协议头之前</li><li>源IP地址、目的IP地址是不能修改的，否则会被检测出来。 </li><li>传输模式下，<strong>NAT与AH冲突，完整性校验失败</strong></li></ul><p><img loading="lazy" alt="img" src="/en/assets/images/20160928233508652-c1e71c4f3ebadb350e27223cd623105a.png" width="840" height="472" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="162-ah隧道模式">1.6.2 AH隧道模式<a href="#162-ah隧道模式" class="hash-link" aria-label="Direct link to 1.6.2 AH隧道模式" title="Direct link to 1.6.2 AH隧道模式">​</a></h4><p>IP隧道技术又称为IP封装技术，它可以将带有源和目标IP地址的数据报文使用新的源和目标IP进行第二次封装，这样这个报文就可以发送到一个指定的目标主机上。</p><p>边际路由器之间的传输。</p><ul><li>隧道模式：AH插在原始的IP头之前，另外生成一个新的IP头放在AH之前；</li><li><strong>加密整个IP数据报</strong>，包括全部TCP/IP或UDP/IP头和数据，并用自己的地址作为源地址加入到新的IP头。</li><li>AH验证的范围也是<strong>整个IP包</strong>，<strong>因此AH和NAT的冲突在隧道模式下也存在</strong></li></ul><p><img loading="lazy" alt="img" src="/en/assets/images/20160928234227474-de958306540347c54101ef130684f896.png" width="880" height="341" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="163-ah加密算法">1.6.3 AH加密算法<a href="#163-ah加密算法" class="hash-link" aria-label="Direct link to 1.6.3 AH加密算法" title="Direct link to 1.6.3 AH加密算法">​</a></h4><p><img loading="lazy" alt="image-20230415163332240" src="/en/assets/images/image-20230415163332240-f9bbcf1ab130a34ddc2a807ac8f07725.png" width="1305" height="611" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="164-ah输入输出处理流程">1.6.4 AH输入输出处理流程<a href="#164-ah输入输出处理流程" class="hash-link" aria-label="Direct link to 1.6.4 AH输入输出处理流程" title="Direct link to 1.6.4 AH输入输出处理流程">​</a></h4><ul><li>输出处理过程：(senders end)<ul><li>SA安全关联查找 Security Association Lookup</li><li>序列号生成 Sequence Number Generation</li><li>ICV计算 ICV computation</li><li>填充 Padding</li><li>分片 Fragmentation</li></ul></li><li>接受处理过程：(receivers end)<ul><li>重组 Reassembly</li><li>安全关联查找 Security Association Lookup</li><li>序列号验证 Sequence Number Verification</li><li>ICV 验证 ICV verification</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="17-espencapsulating-security-payload封装安全载荷">1.7 ESP（Encapsulating Security Payload）封装安全载荷<a href="#17-espencapsulating-security-payload封装安全载荷" class="hash-link" aria-label="Direct link to 1.7 ESP（Encapsulating Security Payload）封装安全载荷" title="Direct link to 1.7 ESP（Encapsulating Security Payload）封装安全载荷">​</a></h3><p>ESP 是插入IP数据包内的一个协议头，可以为IP提供机密性、数据源认证、抗重播以及数据完整性等安 全服务 ESP将需要保护的数据进行加密后，在封装在IP包中，主要支持IP数据项的机密性。 ESP也提供认证服务。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x02-ikeinternet-key-exchange因特网密钥交换协议">0x02 IKE（Internet Key Exchange）因特网密钥交换协议<a href="#0x02-ikeinternet-key-exchange因特网密钥交换协议" class="hash-link" aria-label="Direct link to 0x02 IKE（Internet Key Exchange）因特网密钥交换协议" title="Direct link to 0x02 IKE（Internet Key Exchange）因特网密钥交换协议">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-ipsec与ike的关系">2.1 IPsec与IKE的关系<a href="#21-ipsec与ike的关系" class="hash-link" aria-label="Direct link to 2.1 IPsec与IKE的关系" title="Direct link to 2.1 IPsec与IKE的关系">​</a></h3><ul><li>IKE是<strong>UDP</strong>之上的一个<strong>应用层协议</strong>，是IPsec的信令协议</li><li>IKE为IPsec<strong>协商建立安全联盟</strong>，并把建立的<strong>参数</strong>及生成的<strong>密钥</strong>交给IPsec 。</li><li>IPsec使用IKE建立的安全联盟对IP报文<strong>加密</strong>或<strong>验证</strong>处理</li><li>IPsec处理做为IP层的一部分，在IP层对报文进行处理。AH协议和ESP协议有自己的协议号，分别是 51 和 50。</li></ul><p><img loading="lazy" alt="img" src="/en/assets/images/u=3746441655,3892454399&amp;fm=253&amp;app=138&amp;f=PNG&amp;fmt=auto&amp;q=75-b16d8359e4d87a18bbf1792c95db95d0.png" width="414" height="241" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-ike的安全机制">2.2 IKE的安全机制<a href="#22-ike的安全机制" class="hash-link" aria-label="Direct link to 2.2 IKE的安全机制" title="Direct link to 2.2 IKE的安全机制">​</a></h3><ul><li>完善的前向安全性（PFS：Perfect Forward Security） <ul><li>是密码学中通讯协议<em>的</em>安全属性，指的是长期使用的主密钥泄漏不会导致过去的会话密钥泄漏。</li></ul></li><li>数据验证<ul><li>保证数据<strong>完整性</strong>（发送的数据未被第三方修改过） </li><li><strong>身份保护</strong></li></ul></li><li>DH交换和密钥分发<ul><li>Diffie-Hellman算法是一种公共密钥算法。通信双方在不传送密钥的情况下通过交换一些数据，计算出共享的密钥。</li><li>PFS特性是由DH算法保障的</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-ike协商过程">2.3 IKE协商过程<a href="#23-ike协商过程" class="hash-link" aria-label="Direct link to 2.3 IKE协商过程" title="Direct link to 2.3 IKE协商过程">​</a></h3><p>IKE协商分为两个阶段</p><ul><li><p>阶段一：在网络上建立IKE SA，为其它协议的协商（阶段二）提供保护和快速协商。通过协商创建 一个通信信道，并对该信道进行认证，为双方进一步的IKE通信提供机密性、消息完整性以及消息源认证服务； </p><ul><li>在通信双方之间架设一个安全，认证的信道。</li><li>对通信双方进行认证和保护</li><li>协商待用的SA策略</li><li>实施共享密钥的交换</li><li>为阶段2架设安全通道</li><li>两工作模式: Main mode or Aggressive mode</li></ul></li><li><p>阶段二：快速模式，在IKE SA的保护下完成IPSec的协商。用在第一阶段建立的安全隧道为IPsec协商安全服务，即为IPsec协商具体的SA，建立用于最终的IP数据安全传输的IPsec SA。</p><ul><li><p>n协商IPSec SA 参数</p><p>n为特定的协议构建IPSec (like FTP, telnet, etc)</p><p>n周期性协商 IPSec SA</p><p>n选择性执行DH</p></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="24-阶段一两种模式主模式与野蛮模式">2.4 阶段一两种模式：主模式与野蛮模式<a href="#24-阶段一两种模式主模式与野蛮模式" class="hash-link" aria-label="Direct link to 2.4 阶段一两种模式：主模式与野蛮模式" title="Direct link to 2.4 阶段一两种模式：主模式与野蛮模式">​</a></h3><p>IKE协商过程中包含三对消息： </p><ul><li>第一对叫<strong>SA交换</strong>，是协商确认有关安全策略的过程； </li><li>第二对消息叫<strong>密钥交换</strong>，交换Diffie-Hellman公共值和辅助数据（如：随机数），加密物在这个阶 段产生； </li><li>最后一对消息是<strong>ID信息和验证数据交换</strong>，进行身份验证和对整个SA交换进行验证。</li></ul><p>第一阶段协商的信息如下：</p><p>1、对等体之间采用何种方式做认证，是预共享密钥还是数字证书。</p><p>2、双方使用哪种加密算法（DES、3DES）</p><p>3、双方使用哪种HMAC方式，是MD5还是SHA</p><p>4、双方使用哪种Diffie-Hellman密钥组</p><p>5、使用哪种协商模式（主模式或主动模式）</p><p>6、协商SA的生存期</p><p>第二阶段协商信息如下：</p><p>1、双方使用哪种封装技术，AH还是ESP</p><p>2、双方使用哪种加密算法</p><p>3、双方使用哪种HMAC方式，是MD5还是SHA</p><p>4、使用哪种传输模式，是隧道模式还是传输模式</p><p>5、协商SA的生存期</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/Axsl666/Axsl666.github.io/tree/master/docs/NetworkProtocolSecurity/ipsec.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/NetworkProtocolSecurity/Kerberos"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Kerberos协议</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/NetworkProtocolSecurity/SET"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">SET 协议</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a><ul><li><a href="#ip安全问题" class="table-of-contents__link toc-highlight">IP安全问题</a></li></ul></li><li><a href="#概述" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#ipsec体系" class="table-of-contents__link toc-highlight">IPsec体系</a></li><li><a href="#0x01-ipsec概念" class="table-of-contents__link toc-highlight">0x01 IPsec概念</a><ul><li><a href="#12--sa-security-associations-安全联盟" class="table-of-contents__link toc-highlight">1.2  SA (Security Associations) 安全联盟</a></li><li><a href="#13-sadsecurity-association-data安全关联数据库" class="table-of-contents__link toc-highlight">1.3 SAD（Security Association Data）安全关联数据库</a></li><li><a href="#14-spdsecurity-policy-data安全策略库" class="table-of-contents__link toc-highlight">1.4 SPD（Security Policy Data）安全策略库</a></li><li><a href="#16-ahauthentication-header认证头" class="table-of-contents__link toc-highlight">1.6 AH（Authentication Header）认证头</a></li><li><a href="#17-espencapsulating-security-payload封装安全载荷" class="table-of-contents__link toc-highlight">1.7 ESP（Encapsulating Security Payload）封装安全载荷</a></li></ul></li><li><a href="#0x02-ikeinternet-key-exchange因特网密钥交换协议" class="table-of-contents__link toc-highlight">0x02 IKE（Internet Key Exchange）因特网密钥交换协议</a><ul><li><a href="#21-ipsec与ike的关系" class="table-of-contents__link toc-highlight">2.1 IPsec与IKE的关系</a></li><li><a href="#22-ike的安全机制" class="table-of-contents__link toc-highlight">2.2 IKE的安全机制</a></li><li><a href="#23-ike协商过程" class="table-of-contents__link toc-highlight">2.3 IKE协商过程</a></li><li><a href="#24-阶段一两种模式主模式与野蛮模式" class="table-of-contents__link toc-highlight">2.4 阶段一两种模式：主模式与野蛮模式</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/docs/intro">Notes</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/Axsl666/Axsl666.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Axsl666. Built with Docusaurus.</div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.c25a2a1f.js"></script>
<script src="/en/assets/js/main.2ee74d0e.js"></script>
</body>
</html>